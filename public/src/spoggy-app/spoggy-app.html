<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<!--<link rel="import" href="../../bower_components/paper-fab-menu/paper-fab-menu.html" />-->

<link rel="import" href="../spog-socket/spog-socket.html">
<link rel="import" href="../spog-graphe/spog-graphe.html">
<link rel="import" href="../spog-chat/spog-chat.html">
<link rel="import" href="../spog-room/spog-room.html">
<link rel="import" href="../spog-eye/spog-eye.html">

<dom-module id="spoggy-app">
  <template>
  <style>
  #fabchat {
    position: fixed;
    right: 25px;
    top: 25px;
    z-index: 99;
  }
  #fabgraphe {
    position: fixed;
    right: 25px;
    top: 85px;
    z-index: 99;
  }
  #fabroom {
    position: fixed;
    right: 25px;
    top: 145px;
    z-index: 99;
  }
  #fabeye {
    position: fixed;
    right: 25px;
    top: 205px;
    z-index: 99;
  }
  </style>

  <spog-socket socket="{{socket}}" status="{{status}}"></spog-socket>
  <paper-fab id="fabchat" on-tap="toggleChat"  label="ðŸ˜»"></paper-fab>
  <paper-fab id="fabgraphe" on-tap="toggleGraphe"  label="Graph"></paper-fab>
  <paper-fab id="fabroom" on-tap="toggleRoom"  label="Room"></paper-fab>
  <paper-fab id="fabeye" on-tap="toggleEye"  label="Eye"></paper-fab>

  <div hidden$="[[connected]]">[[status]]</div>


  <spog-chat hidden$="[[!visibleChat]]" id="chat"   socket="[[socket]]" status="[[status]]" ></spog-chat>
  <spog-room hidden$="[[!visibleRoom]]" socket="[[socket]]" ></spog-room>
  <spog-eye hidden$="[[!visibleEye]]" id="eye" data="{{eyedata}}" infered="{{infered}}" ></spog-eye>
    <spog-graphe hidden$="[[!visibleGraphe]]"  socket="[[socket]]" status="[[status]]" actionstosend="{{actionstosend}}"></spog-graphe>

  choix de langue : [[lang]]
</template>

<script>
/**
* @customElement
* @polymer
*/
class SpoggyApp extends Polymer.Element {
  static get is() { return 'spoggy-app'; }
  static get properties() {
    return {
      prop1: {
        type: String,
        value: 'spoggy-app'
      },
      socket: {
        type: Object,
        observer: "_socketChanged"
      },
      status:{
        type: String,
        observer: '_consoleStatus'
      },
      connected:{
        type: Boolean,
      },
      tickDelay: {
        type: Number,
        value: 1000       // 15ms selon source, tempo pour envoi du snapshot par le serveur pour un jeu
      },

      actionstosend: {
        type: Array,
        value:[]
      },
      visibleIcon: {
        type: Boolean,
        value : false
      },
      lang: {
        type: String,
        value: "fr"
      },
      visibleChat: {
        type: Boolean,
        value : false
      },
      visibleGraphe: {
        type: Boolean,
        value : true
      },
      visibleRoom: {
        type: Boolean,
        value : false
      },
      visibleEye: {
        type: Boolean,
        value : false
      },
    };
  }

  ready() {
    super.ready();
    var app=this;
    this.recupParams();
    console.log(this.params);

    var tickInterval = setInterval(function() {
      if (app.connected){
        //  console.log("tick spog-app");
        if (app.actionstosend.length > 0) {
          console.log(app.actionstosend);
          app.socket.emit('newActions', app.actionstosend);
          app.actionstosend = [];
        }}
      }, this.tickDelay);
    }
    _socketChanged(s){
      var app = this;
      s.on('config', function (data) {
        console.log(data);
      });
      s.on('updateroom', function (data) {
        console.log(data);
      });
    }

    _consoleStatus(newValue, oldValue){
      console.log(oldValue +" -> "+ newValue);
      if(newValue =="connected"){
        this.connected = true;
      }else{
        this.connected = false;
      }
    }


    recupParams(){
      var params = (function(a) {
        if (a == "") return {};
        var b = {};
        for (var i = 0; i < a.length; ++i)
        {        var p=a[i].split('=', 2);
        if (p.length == 1)
        b[p[0]] = "";
        else
        b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
      }
      return b;
    })(window.location.search.substr(1).split('&'));
    this.params = params;
  }

  toggleChat(){
    this.visibleChat = !this.visibleChat;
  }
  toggleGraphe(){
    this.visibleGraphe = !this.visibleGraphe;
  }
  toggleRoom(){
    this.visibleRoom = !this.visibleRoom;
  }
  toggleEye(){
    this.visibleEye = !this.visibleEye;
  }
}

window.customElements.define(SpoggyApp.is, SpoggyApp);
</script>
</dom-module>
